import streamlit as st
import random
import time
import re
import torch
from transformers import pipeline

# ---------------------------------------------------
# 1. ËºâÂÖ• Hugging Face Ê®°ÂûãÔºàÁî® cacheÔºåÈÅøÂÖçÊØèÊ¨°ÈáçËºâÔºâ
# ---------------------------------------------------
@st.cache_resource
def load_detector():
    """
    ËºâÂÖ• AI ÊñáÂ≠óÂÅµÊ∏¨Ê®°ÂûãÔºàHugging FaceÔºâ„ÄÇ
    ÈÄôË£°Á§∫ÁØÑ‰ΩøÁî® fakespot-ai/roberta-base-ai-text-detection-v1„ÄÇ
    """
    device = 0 if torch.cuda.is_available() else -1
    clf = pipeline(
        "text-classification",
        model="fakespot-ai/roberta-base-ai-text-detection-v1",
        device=device
    )
    return clf

def clean_text(text: str) -> str:
    """Á∞°ÂñÆÊñáÂ≠óÊ∏ÖÁêÜÔºöÂéªÈô§Â§öÈ§òÁ©∫ÁôΩËàáÊèõË°å„ÄÇ"""
    text = text.replace("\u200b", " ")
    text = text.replace("\n", " ")
    text = re.sub(r"\s+", " ", text)
    return text.strip()


def main():
    """
    Main function to run the AI Content Detector Streamlit app.
    """
    st.set_page_config(page_title="AI Content Detector", page_icon="ü§ñ")

    st.title("AI Content Detector")
    st.write(
        "This tool estimates whether your text is more likely "
        "written by a human or generated by AI."
    )
    st.caption("‚ö† This is a probability estimate, not definitive proof.")

    # Initialize session state
    if 'text_content' not in st.session_state:
        st.session_state.text_content = ""

    sample_texts = [
        "There is no relation at all between Fortier and Profiler but the fact that both are police series about violent crimes. Profiler looks crispy, Fortier looks classic. Profiler plots are quite simple. Fortier's plot are far more complicated... Fortier looks more like Prime Suspect, if we have to spot similarities... The main character is weak and weirdo, but have \"clairvoyance\". People like to compare, to judge, to evaluate. How about just enjoying? Funny thing too, people writing Fortier looks American but, on the other hand, arguing they prefer American series (!!!). Maybe it's the language, or the spirit, but I think this series is more English than American. By the way, the actors are really good and funny. The acting is not superficial at all...",
        "This movie is a great. The plot is very true to the book which is a classic written by Mark Twain. The movie starts of with a scene where Hank sings a song with a bunch of kids called \"when you stub your toe on the moon\" It reminds me of Sinatra's song High Hopes, it is fun and inspirational. The Music is great throughout and my favorite song is sung by the King, Hank (bing Crosby) and Sir \"Saggy\" Sagamore. OVerall a great family movie or even a great Date movie. This is a movie you can watch over and over again. The princess played by Rhonda Fleming is gorgeous. I love this movie!! If you liked Danny Kaye in the Court Jester then you will definitely like this movie.",
        "George P. Cosmatos' \"Rambo: First Blood Part II\" is pure wish-fulfillment. The United States clearly didn't win the war in Vietnam. They caused damage to this country beyond the imaginable and this movie continues the fairy story of the oh-so innocent soldiers. The only bad guys were the leaders of the nation, who made this war happen. The character of Rambo is perfect to notice this. He is extremely patriotic, bemoans that US-Americans didn't appreciate and celebrate the achievements of the single soldier, but has nothing but distrust for leading officers and politicians. Like every film that defends the war (e.g. \"We Were Soldiers\") also this one avoids the need to give a comprehensible reason for the engagement in South Asia. And for that matter also the reason for every single US-American soldier that was there. Instead, Rambo gets to take revenge for the wounds of a whole nation. It would have been better to work on how to deal with the memories, rather than suppressing them. \"Do we get to win this time?\" Yes, you do.",
        "In the process of trying to establish the audiences' empathy with Jake Roedel (Tobey Maguire) the filmmakers slander the North and the Jayhawkers. Missouri never withdrew from the Union and the Union Army was not an invading force. The Southerners fought for State's Rights: the right to own slaves, elect crooked legislatures and judges, and employ a political spoils system. There's nothing noble in that. The Missourians could have easily traveled east and joined the Confederate Army.<br /><br />It seems to me that the story has nothing to do with ambiguity. When Jake leaves the Bushwhackers, it's not because he saw error in his way, he certainly doesn't give himself over to the virtue of the cause of abolition.",
        "Yeh, I know -- you're quivering with excitement. Well, *The Secret Lives of Dentists* will not upset your expectations: it's solidly made but essentially unimaginative, truthful but dull. It concerns the story of a married couple who happen to be dentists and who share the same practice (already a recipe for trouble: if it wasn't for our separate work-lives, we'd all ditch our spouses out of sheer irritation). Campbell Scott, whose mustache and demeanor don't recall Everyman so much as Ned Flanders from *The Simpsons*, is the mild-mannered, uber-Dad husband, and Hope Davis is the bored-stiff housewife who channels her frustrations into amateur opera. One night, as Dad & the daughters attend one of Davis' performances, he discovers that his wife is channeling her frustrations into more than just singing: he witnesses his wife kissing and flirting with the director of opera. (One nice touch: we never see the opera-director's face.) Dreading the prospect of instituting the proceedings for separation, divorce, and custody hearings -- profitable only to the lawyers -- Scott chooses to pretend ignorance of his wife's indiscretions.<br /><br />Already, the literate among you are starting to yawn: ho-hum, another story about the Pathetic, Sniveling Little Cuckold. But Rudolph, who took the story from a Jane Smiley novella, hopes that the wellworn-ness of the material will be compensated for by a series of flashy, postmodern touches. For instance, one of Scott's belligerent patients (Denis Leary, kept relatively -- and blessedly -- in check) will later become a sort of construction of the dentist's imagination, emerging as a Devil-on-the-shoulder advocate for the old-fashioned masculine virtues (\\\"Dump the b---h!\\\", etc.). When not egged-on by his imaginary new buddy, Scott is otherwise tormented by fantasies that include his wife engaged in a three-way with two of the male dental-assistants who work in their practice. It's not going too far to say that this movie is *Eyes Wide Shut* for Real People (or Grown-Ups, at least). Along those lines, Campbell Scott and Hope Davis are certainly recognizable human beings as compared to the glamourpuss pair of Cruise and Kidman. Further, the script for *Secret Lives* is clearly more relevant than Kubrick's. As proof, I offer the depiction of the dentists' children, particularly the youngest one who is about 3 or 4 years old, and whose main utterance is \\\"Dad! Dad! Dad! Dad! Dad! DAD!!!\\\" This is Family Life, all right, with all its charms.<br /><br />The movie would make an interesting double-bill with *Kramer vs. Kramer*, as well. One can easily trace the Feminization of the American Male from 1979 to 2003. In this movie, Dad is the housewife as in *Kramer*, but he is in no way flustered by the domestic role, unlike Dustin Hoffman, who was too manly to make toast. Here, Scott gets all the plumb chores, such as wiping up the children's vomit, cooking, cleaning, taking the kids to whatever inane after-school activity is on the docket. And all without complaint. (And without directorial commentary. It's just taken for granted.)<br /><br />The film has virtues, mostly having to do with verisimilitude. However, it's dragged down from greatness by its insistence on trendy distractions, which culminate in a long scene where a horrible five-day stomach flu makes the rounds in the household. We must endure pointless fantasy sequences, initiated by the imaginary ringleader Leary. Whose existence, by the way, is finally reminiscent of the Brad Pitt character in *Fight Club*. And this finally drives home the film's other big flaw: lack of originality. In this review, I realize it's been far too easy to reference many other films. Granted, this film is an improvement on most of them, but still. *The Secret Lives of Dentists* is worth seeing, but don't get too excited about it. (Not that you were all that excited, anyway. I guess.)",
        "While this movie's style isn't as understated and realistic as a sound version probably would have been, this is still a very good film. In fact, it was seen as an excellent film in its day, as it was nominated for the first Best Picture Oscar (losing to WINGS). I still consider WINGS to be a superior film, but this one is excellent despite a little bit of overacting by the lead, Emil Jannings.<br /><br />Jannings is a general from Czarist Russia who is living out his final days making a few bucks in the 1920s by being a Hollywood extra. His luck appears to have changed as he gets a casting call--to play an Imperial Russian general fighting against the Communists during the revolution. Naturally this isn't much of a stretch acting-wise, but it also gets the old man to thinking about the old days and the revolution.<br /><br />Exactly what happens next I'll leave to you, but it's a pretty good film--particularly at the end. By the way, look for William Powell as the Russian director. Despite being made in 1928, with the makeup he doesn't look much younger than he did in many of his later films.",
        "I give this movie 7 out of 10 because the villains were interesting in their roles and the unknown batwoman creates an interesting \"guess who\" game. The movie, however, needs more Robin in it. He appeared in the movie in the beginning and sporadically throughout the rest. I always thought the new animated series did little justice to the neat new Robin character, let alone Knightwing. This movie just continues that bad tradition. The movie spends too much time on Bruce Wayne and his romance which wouldn't be so bad in one movie if the romance wasn't so unbelievable. It is still a good movie if you are a Batman fan and I would recommend watching it.",
        "really awful... lead actor did OK... the film, plot etc was completely crap and inaccurate it may as well have been a sequel to well... anything it had little or no relevance to Carlitos Way... and should be avoided like the plague by any Carlito's ways fans... no mention of Gail in fact he ends up with some other bird, no mention of Klienfelt, no mention of how he got caught, no mention of how he ended up in jail... they attempted to make it like the original with flash backs at the beginning... but to be honest when rating it I was looking for a zero mark... unfortunately I had to rate it higher...<br /><br />Its a terrible attempt to cash in on what was one of the best films of the 90's... overall it was approximately Áûø6 and 2 hours of my life waste d... for all the \"action\" in it, it was truly boring slow and predictable... again to any Carltio's Way fans avoid this fiasco...",
        "Good grief I can't even begin to describe how poor this film is. Don't get me wrong, I wasn't expecting much to begin with. Let's face it, a PG-13 slasher flick is pre-destined to be missing the ummm... slashing, so no one should be surprised by the lack of gore. But it was the level of incompetence and clichÁüá on display in all the other aspects of this movie is what really blew me away. <br /><br />We have a protagonist who is quite simply so completely useless that you find yourself rooting for the bad guy. And here's a turnup for the books... SHE NEVER CHANGES - hence breaking the cardinal rule of basic screen writing - character development. If you think by the end of this film the poor little girl is going to turn around and finally kick some arse then think again. <br /><br />On top of this, we're handed possibly the least intriguing (and definitely the least scary) killer ever to grace the genre. I'm not joking when I say that Dora the Explorer has scarier villains than this movie.<br /><br />Finally, because all the potential for tension or gratuity is removed by the inept (and apparently thirteen-year-old) director, what could possibly be left to fill up 2 hours of screen time? <br /><br />Closets, that's what. <br /><br />Lots and lots of closets: big closets, small closets, mirrored closets, closets to Narnia, so many damned closets you'll not want to dress yourself for another year. In fact this movie should have just been called \"CLOSET\", and had a picture of a big scary coathanger on the DVD case. On the back it could have had a photograph of the audience falling asleep and a quote by Roger and Ebert - something to the extent of: \"what the f*@! did we just waste our time watching!\"",
        "Home Room deals with a Columbine-like high-school shooting but rather than hashing over the occurrence itself the film portrays the aftermath and what happened to the survivors, their trauma, guilt and denial.<br /><br />*Spoilers* The shooting itself is treated as a foregone conclusion, with no action footage other than the reaction of an almost teenage SWAT commando after shooting the high school killer. The film has three protagonists; a detective investigating the crime of which no guilty parties are left to convict and two teenage girls surviving the incident, played by a very young Erika Christensen and Busy Philipps.<br /><br />The two girls having nothing in common besides the shooting are put together because of it and the drama ensues.<br /><br />Erika Christensen, though only 24 has been around the block so much that film viewers are pretty much acquainted with her solid and reliable style of acting. Busy Philipps, three years older than Christensen and altogether unknown to me, blew me away with her overwhelming dramatic strength and screen presence. This girl was the part.<br /><br />It's a great movie and it connects to you with its intimate focus on the fragile yet growing relationship between the two traumatized girls. Gus van Sant's Elephant (2003) though good, seems almost superficial and paltry compared to Home Room when it comes to dramatic flair and acting. What I can see this film got very little screen time and exposure - so much more a loss for an equally traumatized America.<br /><br />Ten out of Ten"
    ]

    # Text area
    st.session_state.text_content = st.text_area(
        "Enter text to analyze",
        value=st.session_state.text_content,
        height=200
    )

    col1, col2 = st.columns(2)

    with col1:
        if st.button("Use Sample"):
            st.session_state.text_content = random.choice(sample_texts)
            st.rerun()

    with col2:
        if st.button("Check content"):
            if st.session_state.text_content.strip():
                with st.spinner("Analyzing with AI model..."):
                    # ËºâÂÖ•Ê®°Âûã
                    detector = load_detector()
                    # Ê∏ÖÁêÜÊñáÂ≠ó
                    text = clean_text(st.session_state.text_content)
                    # ÂëºÂè´ Hugging Face Ê®°Âûã
                    result = detector(text)[0]  # {'label': 'AI' or 'Human', 'score': float}

                    raw_label = result["label"]
                    raw_score = float(result["score"])

                    # Â∞áÊ®°ÂûãËº∏Âá∫ËΩâÊàê„ÄåAI Ê©üÁéá„Äç
                    # Ë®≠Ë®àÔºöËã• label = AI ‚Üí AI Ê©üÁéá = scoreÔºõHuman ‚Üí 1 - score
                    if raw_label.upper() == "AI":
                        ai_prob = raw_score
                    else:
                        ai_prob = 1.0 - raw_score

                    ai_prob = max(0.0, min(1.0, ai_prob))
                    human_prob = 1.0 - ai_prob

                    human_score = human_prob * 100

                    time.sleep(0.5)  # Â∞èÂª∂ÈÅ≤Â¢ûÂä†„ÄåÂàÜÊûêÊÑü„Äç

                st.subheader("Analysis Result")

                # Progress bar È°ØÁ§∫„ÄåHuman Content %„Äç
                st.write(f"**{human_score:.1f}% Human Content**")
                st.progress(human_prob)

                # ÊñáÊ°àÈÇèËºØ‰øùÊåÅÊé•Ëøë‰Ω†ÂéüÊú¨ÁöÑ
                if human_score > 80:
                    st.success("This text is likely written by a human.")
                elif human_score > 60:
                    st.warning("This text may contain some AI-generated content.")
                else:
                    st.error("This text is likely AI-generated.")



            else:
                st.warning("Please enter some text to analyze.")

if __name__ == "__main__":
    main()