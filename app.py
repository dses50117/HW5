import streamlit as st
import random
import time
import re
import torch
from transformers import pipeline

# ---------------------------------------------------
# 1. è¼‰å…¥ Hugging Face æ¨¡å‹ï¼ˆç”¨ cacheï¼Œé¿å…æ¯æ¬¡é‡è¼‰ï¼‰
# ---------------------------------------------------
@st.cache_resource
def load_detector():
    """
    è¼‰å…¥ AI æ–‡å­—åµæ¸¬æ¨¡å‹ï¼ˆHugging Faceï¼‰ã€‚
    é€™è£¡ç¤ºç¯„ä½¿ç”¨ fakespot-ai/roberta-base-ai-text-detection-v1ã€‚
    """
    device = 0 if torch.cuda.is_available() else -1
    clf = pipeline(
        "text-classification",
        model="fakespot-ai/roberta-base-ai-text-detection-v1",
        device=device
    )
    return clf

def clean_text(text: str) -> str:
    """ç°¡å–®æ–‡å­—æ¸…ç†ï¼šå»é™¤å¤šé¤˜ç©ºç™½èˆ‡æ›è¡Œã€‚"""
    text = text.replace("\u200b", " ")
    text = text.replace("\n", " ")
    text = re.sub(r"\s+", " ", text)
    return text.strip()


def main():
    """
    Main function to run the AI Content Detector Streamlit app.
    """
    st.set_page_config(page_title="AI Content Detector", page_icon="ğŸ¤–")

    st.title("AI Content Detector")
    st.write(
        "This tool estimates whether your text is more likely "
        "written by a human or generated by AI."
    )
    st.caption("âš  This is a probability estimate, not definitive proof.")

    # Initialize session state
    if 'text_content' not in st.session_state:
        st.session_state.text_content = ""

    sample_texts = [
        "The quick brown fox jumps over the lazy dog. This is a classic pangram often used for testing typefaces and keyboards. It contains every letter of the English alphabet.",
        "Artificial intelligence (AI) is intelligence demonstrated by machines, unlike the natural intelligence displayed by humans and animals. Leading AI textbooks define the field as the study of 'intelligent agents': any device that perceives its environment and takes actions that maximize its chance of successfully achieving its goals.",
        "The sun always shines brightest after the rain. Life is full of ups and downs, but it's important to remember that challenges are temporary and opportunities for growth are always present. Embrace change and keep moving forward.",
        "In a world where information is constantly flowing, critical thinking skills are more important than ever. Learning to evaluate sources, identify biases, and construct logical arguments are essential for navigating complex issues and making informed decisions.",
        "The history of the internet is a fascinating journey from a military research project to a global communication network. It has revolutionized how we work, learn, and interact with each other, constantly evolving with new technologies and applications."
    ]

    # Text area
    st.session_state.text_content = st.text_area(
        "Enter text to analyze",
        value=st.session_state.text_content,
        height=200
    )

    col1, col2 = st.columns(2)

    with col1:
        if st.button("Use Sample"):
            st.session_state.text_content = random.choice(sample_texts)
            st.rerun()

    with col2:
        if st.button("Check content"):
            if st.session_state.text_content.strip():
                with st.spinner("Analyzing with AI model..."):
                    # è¼‰å…¥æ¨¡å‹
                    detector = load_detector()
                    # æ¸…ç†æ–‡å­—
                    text = clean_text(st.session_state.text_content)
                    # å‘¼å« Hugging Face æ¨¡å‹
                    result = detector(text)[0]  # {'label': 'AI' or 'Human', 'score': float}

                    raw_label = result["label"]
                    raw_score = float(result["score"])

                    # å°‡æ¨¡å‹è¼¸å‡ºè½‰æˆã€ŒAI æ©Ÿç‡ã€
                    # è¨­è¨ˆï¼šè‹¥ label = AI â†’ AI æ©Ÿç‡ = scoreï¼›Human â†’ 1 - score
                    if raw_label.upper() == "AI":
                        ai_prob = raw_score
                    else:
                        ai_prob = 1.0 - raw_score

                    ai_prob = max(0.0, min(1.0, ai_prob))
                    human_prob = 1.0 - ai_prob

                    human_score = human_prob * 100

                    time.sleep(0.5)  # å°å»¶é²å¢åŠ ã€Œåˆ†ææ„Ÿã€

                st.subheader("Analysis Result")

                # Progress bar é¡¯ç¤ºã€ŒHuman Content %ã€
                st.write(f"**{human_score:.1f}% Human Content**")
                st.progress(human_prob)

                # æ–‡æ¡ˆé‚è¼¯ä¿æŒæ¥è¿‘ä½ åŸæœ¬çš„
                if human_score > 80:
                    st.success("This text is likely written by a human.")
                elif human_score > 60:
                    st.warning("This text may contain some AI-generated content.")
                else:
                    st.error("This text is likely AI-generated.")

                # é¡å¤–é¡¯ç¤ºæ¨¡å‹åŸå§‹è¼¸å‡ºï¼ˆçµ¦ä½  debug / å¯«è«–æ–‡ï¼‰
                with st.expander("Model raw output"):
                    st.json(result)

            else:
                st.warning("Please enter some text to analyze.")

if __name__ == "__main__":
    main()